
// --- Article Interactions (Likes & Comments) ---

async function loadLikes(id) {
    try {
        const token = localStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const res = await fetch(`${API_URL}/articles/${id}/like`, { headers });
        const data = await res.json();

        const btn = document.getElementById('like-btn');
        if (!btn) return;

        if (data.liked) {
            btn.classList.add('liked');
            btn.innerHTML = `<i class="ph-fill ph-heart"></i> Beğendin & Destek Oldun`;
        } else {
            btn.innerHTML = `<i class="ph ph-heart"></i> Beğen & Destek Ol`;
        }
    } catch (e) { console.error('Like load', e); }
}

async function toggleLike() {
    const token = localStorage.getItem('token');
    if (!token) {
        openModal('loginModal');
        return;
    }

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const btn = document.getElementById('like-btn');

    try {
        // Optimistic UI
        const isLiked = btn.classList.contains('liked');

        if (isLiked) {
            btn.classList.remove('liked');
            btn.innerHTML = `<i class="ph ph-heart"></i> Beğen & Destek Ol`;
        } else {
            btn.classList.add('liked');
            btn.innerHTML = `<i class="ph-fill ph-heart"></i> Beğendin & Destek Oldun`;
        }

        const res = await fetch(`${API_URL}/articles/${id}/like`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) {
            loadLikes(id); // Revert on error
        }
    } catch (e) { console.error(e); }
}

async function loadComments(id) {
    try {
        const token = localStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

        const res = await fetch(`${API_URL}/articles/${id}/comments`, { headers });
        if(!res.ok) return;
        const comments = await res.json();

        const countEl = document.getElementById('comment-count');
        if(countEl) countEl.innerText = comments.length;
        
        const list = document.getElementById('comments-list');
        if(!list) return;

        if (comments.length === 0) {
            list.innerHTML = '<div class="comment-item placeholder" style="justify-content:center; color:#94a3b8; font-style:italic;">Henüz yorum yapılmamış. İlk yorumu siz yapın!</div>';
        } else {
            list.innerHTML = comments.map(c => {
                const initials = c.fullname.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                return `
                <div class="comment-item" id="comment-${c.id}">
                    <div class="comment-avatar">${initials}</div>
                    <div class="comment-content-wrapper">
                        <div class="comment-header">
                            <span class="comment-author">${escapeHtml(c.fullname)}</span>
                            ${c.is_approved === 0 ? '<span class="comment-status-pending"><i class="ph ph-clock" style="margin-right:4px;"></i> Onay Bekliyor</span>' : ''}
                            <div class="comment-actions">
                                <span class="comment-date">${new Date(c.created_at).toLocaleDateString('tr-TR')}</span>
                                ${c.is_mine ? `
                                    <span style="margin: 0 8px; color:#cbd5e1;">|</span>
                                    <span class="action-link" onclick="startEdit(${c.id})"><i class="ph ph-pencil"></i> Düzenle</span>
                                    <span class="action-link delete" onclick="deleteComment(${c.id})"><i class="ph ph-trash"></i> Sil</span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="comment-body" id="body-${c.id}">${escapeHtml(c.content)}</div>
                        <div id="edit-form-${c.id}" style="display:none;"></div>
                    </div>
                </div>
            `}).join('');
        }

        // Setup Form
        const formContainer = document.getElementById('comment-form-container');
        if(formContainer) {
            if (token) {
                formContainer.innerHTML = `
                    <textarea id="comment-input" placeholder="Düşüncelerinizi paylaşın..."></textarea>
                    <button class="btn-primary" onclick="postComment()" style="float: right;">Yorum Yap</button>
                    <div style="clear: both;"></div>
                `;
            } else {
                formContainer.innerHTML = '<p class="login-prompt">Yorum yapabilmek için <a href="#" onclick="openModal(\'loginModal\')">giriş yapmalısınız</a>.</p>';
            }
        }

    } catch (e) { console.error(e); }
}

async function postComment() {
    const content = document.getElementById('comment-input').value;
    if (!content || !content.trim()) return showToast('Lütfen bir yorum yazın', 'error');

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const token = localStorage.getItem('token');

    try {
        const res = await fetch(`${API_URL}/articles/${id}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ content })
        });

        if (res.ok) {
            showToast('Yorumunuz gönderildi! Editör onayından sonra yayınlanacaktır.', 'success');
            document.getElementById('comment-input').value = '';
            loadComments(id);
        } else {
            const data = await res.json();
            showToast(data.message || 'Hata oluştu', 'error');
        }
    } catch (e) { console.error(e); }
}

function startEdit(id) {
    const bodyEl = document.getElementById(`body-${id}`);
    const currentContent = bodyEl.innerText;
    const formContainer = document.getElementById(`edit-form-${id}`);

    bodyEl.style.display = 'none';
    formContainer.style.display = 'block';
    formContainer.innerHTML = `
        <textarea class="edit-area" id="edit-input-${id}" rows="3">${escapeHtml(currentContent)}</textarea>
        <div style="margin-top: 8px; text-align: right;">
            <button class="btn btn-login" style="padding: 6px 12px; font-size: 0.8rem;" onclick="cancelEdit(${id})">İptal</button>
            <button class="btn btn-signup" style="padding: 6px 12px; font-size: 0.8rem;" onclick="saveEdit(${id})">Kaydet</button>
        </div>
    `;
}

function cancelEdit(id) {
    document.getElementById(`body-${id}`).style.display = 'block';
    document.getElementById(`edit-form-${id}`).style.display = 'none';
}

async function saveEdit(id) {
    const content = document.getElementById(`edit-input-${id}`).value;
    if (!content.trim()) return showToast('Yorum boş olamaz', 'error');

    const token = localStorage.getItem('token');
    try {
        const res = await fetch(`${API_URL}/comments/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ content })
        });

        if (res.ok) {
            showToast('Yorum güncellendi ve tekrar onaya gönderildi.', 'success');
            const params = new URLSearchParams(window.location.search);
            loadComments(params.get('id'));
        } else {
            showToast('Güncelleme başarısız', 'error');
        }
    } catch (e) { console.error(e); }
}

async function deleteComment(id) {
    if (!confirm('Bu yorumu silmek istediğinize emin misiniz?')) return;
    const token = localStorage.getItem('token');
    try {
        const res = await fetch(`${API_URL}/comments/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) {
            showToast('Yorum silindi', 'success');
            document.getElementById(`comment-${id}`).remove();
        } else {
            showToast('Silme başarısız', 'error');
        }
    } catch (e) { console.error(e); }
}
